name: Release Package to GitHub Packages

on:
  release:
    types: [created] # Trigger workflow when a new release is published

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2 # Use bun setup action

      - name: Install dependencies
        run: bun install --frozen-lockfile # Use bun install

      - name: Build package
        run: bun run build # Use bun build script

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
      - name: Upload onnx file
        uses: actions/upload-artifact@v4
        with:
          name: onnx
          path: silero_vad.onnx

  publish:
    needs: build # Run only after the build job is successful
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # Need permission to write packages
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/
      - name: Download onnx file
        uses: actions/download-artifact@v4
        with:
          name: onnx
          path: . # Download ONNX to root for publishing

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Setup Node.js for publishing
        uses: actions/setup-node@v4
        with:
          node-version: '20.x' # Or your preferred Node.js version compatible with bun publish
          registry-url: 'https://npm.pkg.github.com'
          scope: '@adjustleads' # Scope for GitHub Packages

      # Bun install might not be strictly necessary here if publish doesn't need devDeps
      # but running it ensures the environment is consistent.
      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Publish to GitHub Packages
        run: bun publish --no-git-checks # Use bun publish, skip git checks as version is set
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
